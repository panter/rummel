image: node:20-alpine

services:
  - name: docker:dind
    command: ["--tls=false"]

variables:
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  TESTCONTAINERS_HOST_OVERRIDE: "host.docker.internal"
  KUBERNETES_CPU_REQUEST: "0.5"
  KUBERNETES_CPU_LIMIT: "1"
  KUBERNETES_MEMORY_REQUEST: 2Gi
  KUBERNETES_MEMORY_LIMIT: 4Gi

cache:
  - key: yarn-workspace
    paths:
      - node_modules/
      - .yarn

stages:
  - build
  - test
  - comment
  - release

build-lib:
  stage: build
  only: ["merge_requests", "main"]
  script:
    - yarn --immutable
    - yarn build  --filter='./libs/*'
  artifacts:
    paths:
      - libs/crud/dist
      - libs/nestjs-utils/dist

build-samples:
  stage: build
  only: ["merge_requests", "main"]
  allow_failure: true
  script:
    - yarn --immutable
    - yarn build  --filter='./samples/*'
  artifacts:
    paths:
      - libs/crud/dist
      - libs/nestjs-utils/dist

# changeset-mr-comment:
#   stage: comment
#   only: ["merge_requests"]
#   script:
#     - yarn --immutable
#     - yarn changesets-gitlab comment

lint-lib:
  stage: test
  only: ["merge_requests", "main"]
  script:
    - yarn --immutable
    - yarn turbo run lint --filter='./libs/*'
  cache:
    paths:
      - node_modules/
      - .yarn

# manual beacuse not working properly:
# Could not find a working container runtime strategy
# const pgContainer = await new PostgreSqlContainer()'
test-lib:
  stage: test
  only: ["merge_requests", "main"]
  allow_failure: true
  when: manual
  script:
    - yarn --immutable
    - yarn turbo run test --filter='./libs/*'
  artifacts:
    paths:
      - libs/**/coverage*/
  cache:
    paths:
      - node_modules/
      - .yarn

test-samples:
  stage: test
  only: ["merge_requests", "main"]
  allow_failure: true
  script:
    - yarn --immutable
    - yarn turbo run test --filter='./samples/*'
    - yarn turbo run lint --filter='./samples/*'
  cache:
    paths:
      - node_modules/
      - .yarn

release:
  stage: release
  only: ["main"]
  script:
    - apk add --no-cache git
    - yarn --immutable
    - yarn postinstall
    - yarn changesets-gitlab
  variables:
    INPUT_PUBLISH: yarn release
